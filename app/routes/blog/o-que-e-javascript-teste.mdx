---
title: But really, what is a JavaScript test?
date: 2018-01-01
meta:
    title: Teste Javascript
    description: Entendendo testes em JavaScript from scratch!
---

#### Testar c√≥digo. 

Existem milhares de motivos para testar um c√≥digo. Cito meus dois favoritos:
1. Pensar no resultado que eu quero chegar antes de codar.  
2. Confian√ßa de que o que eu fiz n√£o vai quebrar o software.

Dito isso, eu tenho algumas **perguntas** para voc√™:
- Voc√™ j√° escreveu algum teste em Javascript?
- Voc√™ j√° usou algum framework de teste em Javascript?
- Voc√™ entende bem sobre framework de testes a ponto de criar um pr√≥prio, ainda que bem simples?


O **objetivo** desse post √© que voc√™ consiga responder "sim" para as perguntas que fiz acima, mas eu queria mesmo √© que voc√™
sentisse o que eu senti ao conseguir respond√™-las pela primeira vez quando terminei de ler o [post](https://kentcdodds.com/blog/but-really-what-is-a-javascript-test) do Kent C Dodds sobre esse assunto.

#### Vamos come√ßar! (E eu estou bem animado com isso!)

Primeiro vamos criar um simples modulo `math.js` com duas fun√ß√µes de matem√°tica
e escrever testes para essas fun√ß√µes:

```js
const somar = (a, b) => a + b
const subtrair = (a, b) => a - b

module.exports = {somar, subtrair}
```

Fiz um [repo no GitHub](https://github.com/venancioigor/js-teste-exemplo)
onde voc√™ pode se guiar, caso se perca em algum momento. Sugiro que voc√™ acesse
o repo s√≥ em **√∫ltimo caso**, depois de tentar e pensar em como resolver por no m√≠nimo dois dias. üòÖ


### Passo 1

Qual √© o teste mais b√°sico que voc√™ consegue pensar?
Eis um exemplo com vari√°veis em ingl√™s. No final desse post voc√™ entender√° a raz√£o.

```js
// teste-basico.js
const actual = true
const expected = false
if (actual !== expected) {
  throw new Error(`${actual} √© diferente de ${expected}`)
}
```
Voi l√°! Temos o nosso primeiro teste!

Voc√™ pode rod√°-lo digitando `node teste-basico.js` no console e apertando enter.

**Como podemos ver, um teste √© um c√≥digo que lan√ßa um erro quando o resultado
atual n√£o √© o resultado esperado.**

A parte que faz essa verifica√ß√£o `actual !== expected` √© chamada de **asser√ß√£o**,
que √© basicamente verificar se o nosso resultado √© igual ao resultado esperado.
Se n√£o for, lan√ßa-se uma exce√ß√£o.

Para saber mais sobre asser√ß√£o, l√≥gica proposal [clique aqui.](https://www.infoescola.com/matematica/logica-proposicional/)

Ent√£o, qual √© o teste mais b√°sico que poder√≠amos fazer para as nossas fun√ß√µes do m√≥dulo `math.js`?

```js
// 1.js
const {somar, subtrair} = require('./math')

let result, expected

result = somar(2, 2)
expected = 4

if(result !== expected){
  throw new Error(`${result} √© diferente do resultado esperado: ${expected}`)
}

result = subtrair(4, 2)
expected = 2

if(result !== expected){
  throw new Error(`${result} √© diferente do resultado esperado: ${expected}`)
}

```

Rodando esses testes `node 1.js` voc√™ vai ver que n√£o nenhum erro apareceu no console.
Agora vamos fazer esse teste quebrar? No modulo math.js, vamos alterar o comportamento
da fun√ß√£o somar para ao inv√©s de somar, subtrair.

```js
// math.js
const somar = (a, b) => a - b
```

Pronto!

```js
$ node 1.js
C:\source\github\js-teste-exemplo\1.js:10
    throw new Error(`${actual} √© diferente do resultado esperado ${expected}`)
    ^

Error: 0 √© diferente de 4
    at Object.<anonymous> (C:\source\github\js-teste-exemplo\1.js:10:11)
    at Module._compile (node:internal/modules/cjs/loader:1103:14)
    at Object.Module._extensions..js (node:internal/modules/cjs/loader:1155:10)
    at Module.load (node:internal/modules/cjs/loader:981:32)
    at Function.Module._load (node:internal/modules/cjs/loader:822:12)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:77:12)
    at node:internal/main/run_main_module:17:47
```

Deu para perceber que n√£o podemos fazer alguma altera√ß√£o na fun√ß√£o `somar`
sem que quebre os nossos testes autom√°ticos? Estamos protegidos!

**√â essencial que a mensagem de erro seja clara e concisa, onde podemos rapidamente
ver onde est√° o problema e corrigir.**


### Step 2

Did you know that Node actually has
[an](https://nodejs.org/api/assert.html#assert_assert)
[`assert`](https://nodejs.org/api/assert.html#assert_assert)
[module](https://nodejs.org/api/assert.html#assert_assert) for making assertions
like the one we have above ü§î? Let's refactor our test to use that module!

```js
// 2.js
const assert = require('assert')
const {sum, subtract} = require('./math')

let result, expected

result = sum(3, 7)
expected = 10
assert.strictEqual(result, expected)

result = subtract(7, 3)
expected = 4
assert.strictEqual(result, expected)
```

Nice! This is still a test module. This is functionally equivalent to what we
had before. The only difference is the error message:

```
$ node 2.js
assert.js:42
  throw new errors.AssertionError({
  ^

AssertionError [ERR_ASSERTION]: -4 === 10
    at Object.<anonymous> (/Users/kdodds/Desktop/js-test-example/2.js:8:8)
    at Module._compile (module.js:635:30)
    at Object.Module._extensions..js (module.js:646:10)
    at Module.load (module.js:554:32)
    at tryModuleLoad (module.js:497:12)
    at Function.Module._load (module.js:489:3)
    at Function.Module.runMain (module.js:676:10)
    at startup (bootstrap_node.js:187:16)
    at bootstrap_node.js:608:3
```

You'll notice that the error thrown no longer includes any of our own code in it
which is a shame... üò¶ But let's keep going.

### Step 3

Let's go ahead and write our own simple testing "framework" and assertion
library. We'll start with the assertion library. So instead of Node's built-in
`assert` module we'll create a library we'll call `expect`. Here's our
refactored test with that change:

```js
// 3.js
const {sum, subtract} = require('./math')

let result, expected

result = sum(3, 7)
expected = 10
expect(result).toBe(expected)

result = subtract(7, 3)
expected = 4
expect(result).toBe(expected)

function expect(actual) {
  return {
    toBe(expected) {
      if (actual !== expected) {
        throw new Error(`${actual} is not equal to ${expected}`)
      }
    },
  }
}
```

Cool, so now we can add a bunch of assertions on that object we return (like
`toMatchRegex` or `toHaveLength`). Oh, and here's the error message now:

```
$ node 3.js
/Users/kdodds/Desktop/js-test-example/3.js:17
        throw new Error(`${actual} is not equal to ${expected}`)
        ^

Error: -4 is not equal to 10
    at Object.toBe (/Users/kdodds/Desktop/js-test-example/3.js:17:15)
    at Object.<anonymous> (/Users/kdodds/Desktop/js-test-example/3.js:7:16)
    at Module._compile (module.js:635:30)
    at Object.Module._extensions..js (module.js:646:10)
    at Module.load (module.js:554:32)
    at tryModuleLoad (module.js:497:12)
    at Function.Module._load (module.js:489:3)
    at Function.Module.runMain (module.js:676:10)
    at startup (bootstrap_node.js:187:16)
    at bootstrap_node.js:608:3
```

Ok, things are looking good.

### Step 4

But now here's the problem üòñ... If I see that error message, how do I know that
the `sum` function is the one that's broken? It could be the `subtract` module.
Also, the source of the test doesn't do a good job of keeping tests isolated
(visually or otherwise).

So let's write a helper function to make that work:

```js
// 4.js
const {sum, subtract} = require('./math')

test('sum adds numbers', () => {
  const result = sum(3, 7)
  const expected = 10
  expect(result).toBe(expected)
})

test('subtract subtracts numbers', () => {
  const result = subtract(7, 3)
  const expected = 4
  expect(result).toBe(expected)
})

function test(title, callback) {
  try {
    callback()
    console.log(`‚úì ${title}`)
  } catch (error) {
    console.error(`‚úï ${title}`)
    console.error(error)
  }
}

function expect(actual) {
  return {
    toBe(expected) {
      if (actual !== expected) {
        throw new Error(`${actual} is not equal to ${expected}`)
      }
    },
  }
}
```

Now we can put everything relevant to a given test within our "test" callback
function and we can give that test a name. Then we use that `test` function to
not only give a more helpful error message but also run all the tests in the
file (without bailing on the first error)! Here's the output now:

```
$ node 4.js
‚úï sum adds numbers
Error: -4 is not equal to 10
    at Object.toBe (/Users/kdodds/Desktop/js-test-example/4.js:29:15)
    at test (/Users/kdodds/Desktop/js-test-example/4.js:6:18)
    at test (/Users/kdodds/Desktop/js-test-example/4.js:17:5)
    at Object.<anonymous> (/Users/kdodds/Desktop/js-test-example/4.js:3:1)
    at Module._compile (module.js:635:30)
    at Object.Module._extensions..js (module.js:646:10)
    at Module.load (module.js:554:32)
    at tryModuleLoad (module.js:497:12)
    at Function.Module._load (module.js:489:3)
    at Function.Module.runMain (module.js:676:10)
‚úì subtract subtracts numbers
```

Sweet! Now we see the error itself _and_ we see the title of the test so we know
which one to go about fixing.

### Step 5

So all we need to do now is
[write a CLI tool](/blog/tips-for-making-a-cli-based-tool-with-node) that will
search for all our test files and run them! That bit is pretty simple at first,
but there are a LOT of things we can add on top of it. üòÖ

At this point, we're building a testing framework and test runner. Luckily for
us, there are a bunch of these built already! I've tried a ton of them and
they're all great. That said, nothing comes close to serving my use cases better
than [Jest](https://facebook.github.io/jest) üÉè. It's an amazing tool
([learn more about Jest here](http://kcd.im/egghead-jest)).

So, instead of building our own framework, let's just go ahead and switch our
test file to work with Jest. As it so happens, it already does! All we have to
do is remove our own implementation of `test` and `expect` because Jest includes
those in our tests as global objects! So here's what it looks like now:

```js
// 5.js
const {sum, subtract} = require('./math')

test('sum adds numbers', () => {
  const result = sum(3, 7)
  const expected = 10
  expect(result).toBe(expected)
})

test('subtract subtracts numbers', () => {
  const result = subtract(7, 3)
  const expected = 4
  expect(result).toBe(expected)
})
```

When we run this file with Jest, here's what the output looks like:

```
$ jest
 FAIL  ./5.js
  ‚úï sum adds numbers (5ms)
  ‚úì subtract subtracts numbers (1ms)

‚óè sum adds numbers

expect(received).toBe(expected)

    Expected value to be (using Object.is):
      10
    Received:
      -4

      4 |   const result = sum(3, 7)
      5 |   const expected = 10
    > 6 |   expect(result).toBe(expected)
      7 | })
      8 |
      9 | test('subtract subtracts numbers', () => {

      at Object.<anonymous>.test (5.js:6:18)

Test Suites: 1 failed, 1 total
Tests:       1 failed, 1 passed, 2 total
Snapshots:   0 total
Time:        0.6s, estimated 1s
Ran all test suites.
```

You can't tell from the text, but that output is colored. Here's an image of the
output:

![Screenshot of the output from running¬†jest](https://res.cloudinary.com/kentcdodds-com/image/upload/v1625032584/kentcdodds.com/content/blog/but-really-what-is-a-javascript-test/0.png)

It has color coding which is really helpful in identifying the parts that are
relevant üòÄ **It also shows the code where the error was thrown! Now _that's_ a
helpful error message!**

### Conclusion

So, what's a JavaScript test? It's simply some code which sets up some state,
performs some action, and makes an assertion on the new state. We didn't talk
about
[common framework helper functions](https://facebook.github.io/jest/docs/en/api.html)
like
[`beforeEach`](https://facebook.github.io/jest/docs/en/api.html#beforeeachfn-timeout)
or
[`describe`](https://facebook.github.io/jest/docs/en/api.html#describename-fn),
and there are a lot more
[assertions](https://facebook.github.io/jest/docs/en/expect.html) we could add
like
[`toMatchObject`](https://facebook.github.io/jest/docs/en/expect.html#tomatchobjectobject)
or
[`toContain`](https://facebook.github.io/jest/docs/en/expect.html#tocontainitem).
But hopefully this gives you an idea of the fundamental concepts of testing with
JavaScript.

I hope this is helpful to you! Good luck! üëç
